
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // Allow a user to create their own profile document if:
      // 1. They are authenticated.
      // 2. The document ID ({userId}) matches their auth UID.
      // 3. The 'uid' field in the document data also matches their auth UID.
      // 4. The 'email' field in the document data matches their auth token's email.
      allow create: if request.auth != null &&
                       request.auth.uid == userId &&
                       request.resource.data.uid == request.auth.uid &&
                       request.resource.data.email == request.auth.token.email;
      allow update: if request.auth != null && request.auth.uid == userId; // Allow user to update their own profile
      allow delete: if false; // Generally, users shouldn't delete their own profiles directly
    }

    match /sessions/{sessionId} {
      // Admins can read/write all sessions
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Coaches can create sessions.
      // Coaches can read/update sessions where their coachId matches.
      allow create: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'coach';
      allow read, update: if request.auth != null &&
                             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'coach' &&
                             resource.data.coachId == request.auth.uid;

      // Clients can read sessions where their clientId matches.
      allow read: if request.auth != null &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'client' &&
                     resource.data.clientId == request.auth.uid;

      // Default deny for delete unless admin (covered above) or more specific rules are added
      allow delete: if false;
    }
  }
}
