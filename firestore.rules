rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // A user can create their own document if the document ID is their UID.
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // A user can read or update their own document.
      allow read, update: if request.auth != null && request.auth.uid == userId;

      // No one can delete for now.
      allow delete: if false;
    }

    match /sessions/{sessionId} {
      // A coach can create/update a session.
      // For creation, the coachId in the new document must match the creator's UID.
      // For update, the coachId in the existing document must match the updater's UID.
      allow create: if request.auth.uid == request.resource.data.coachId;
      allow update: if request.auth.uid == resource.data.coachId;

      // The client or the coach associated with the session can read it.
      allow read: if request.auth.uid == resource.data.clientId || request.auth.uid == resource.data.coachId;
      
      // Deleting sessions is disabled for now for safety.
      allow delete: if false;
    }
  }
}
